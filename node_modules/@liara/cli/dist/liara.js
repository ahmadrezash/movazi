#!/usr/bin/env node
/******/ (function(modules) { // webpackBootstrap
/******/ 	// The module cache
/******/ 	var installedModules = {};
/******/
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/
/******/ 		// Check if module is in cache
/******/ 		if(installedModules[moduleId]) {
/******/ 			return installedModules[moduleId].exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = installedModules[moduleId] = {
/******/ 			i: moduleId,
/******/ 			l: false,
/******/ 			exports: {}
/******/ 		};
/******/
/******/ 		// Execute the module function
/******/ 		modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);
/******/
/******/ 		// Flag the module as loaded
/******/ 		module.l = true;
/******/
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/
/******/
/******/ 	// expose the modules object (__webpack_modules__)
/******/ 	__webpack_require__.m = modules;
/******/
/******/ 	// expose the module cache
/******/ 	__webpack_require__.c = installedModules;
/******/
/******/ 	// define getter function for harmony exports
/******/ 	__webpack_require__.d = function(exports, name, getter) {
/******/ 		if(!__webpack_require__.o(exports, name)) {
/******/ 			Object.defineProperty(exports, name, {
/******/ 				configurable: false,
/******/ 				enumerable: true,
/******/ 				get: getter
/******/ 			});
/******/ 		}
/******/ 	};
/******/
/******/ 	// getDefaultExport function for compatibility with non-harmony modules
/******/ 	__webpack_require__.n = function(module) {
/******/ 		var getter = module && module.__esModule ?
/******/ 			function getDefault() { return module['default']; } :
/******/ 			function getModuleExports() { return module; };
/******/ 		__webpack_require__.d(getter, 'a', getter);
/******/ 		return getter;
/******/ 	};
/******/
/******/ 	// Object.prototype.hasOwnProperty.call
/******/ 	__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };
/******/
/******/ 	// __webpack_public_path__
/******/ 	__webpack_require__.p = "";
/******/
/******/ 	// Load entry module and return exports
/******/ 	return __webpack_require__(__webpack_require__.s = 11);
/******/ })
/************************************************************************/
/******/ ([
/* 0 */
/***/ (function(module, exports) {

module.exports = require("chalk");

/***/ }),
/* 1 */
/***/ (function(module, exports) {

module.exports = require("fs-extra");

/***/ }),
/* 2 */
/***/ (function(module, exports, __webpack_require__) {

module.exports = __webpack_require__(17);


/***/ }),
/* 3 */
/***/ (function(module, exports) {

module.exports = require("path");

/***/ }),
/* 4 */
/***/ (function(module, exports) {

module.exports = require("os");

/***/ }),
/* 5 */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
/* harmony export (immutable) */ __webpack_exports__["a"] = error;
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0_chalk__ = __webpack_require__(0);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0_chalk___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_0_chalk__);


function error(err) {
  console.log(Object(__WEBPACK_IMPORTED_MODULE_0_chalk__["red"])('> Error!'), err);
}

/***/ }),
/* 6 */
/***/ (function(module, exports) {

module.exports = require("axios");

/***/ }),
/* 7 */
/***/ (function(module, exports) {

module.exports = require("async-retry");

/***/ }),
/* 8 */
/***/ (function(module, exports) {

module.exports = require("inquirer");

/***/ }),
/* 9 */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator__ = __webpack_require__(2);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1_axios__ = __webpack_require__(6);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1_axios___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_1_axios__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_2_async_retry__ = __webpack_require__(7);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_2_async_retry___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_2_async_retry__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_3_inquirer__ = __webpack_require__(8);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_3_inquirer___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_3_inquirer__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_4_fs_extra__ = __webpack_require__(1);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_4_fs_extra___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_4_fs_extra__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_5__util_erase_lines__ = __webpack_require__(27);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_6__util_prompt_email__ = __webpack_require__(29);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_7_email_validator__ = __webpack_require__(31);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_7_email_validator___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_7_email_validator__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_8_chalk__ = __webpack_require__(0);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_8_chalk___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_8_chalk__);


function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }










// @TODO Add support for --email and --password args

/* harmony default export */ __webpack_exports__["a"] = ((function () {
  var _ref = _asyncToGenerator( /*#__PURE__*/__WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator___default.a.mark(function _callee2(args, config) {
    var _this = this;

    var debug, email, emailIsValid, erase, _ref2, password, _ref3, api_token;

    return __WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator___default.a.wrap(function _callee2$(_context2) {
      while (1) {
        switch (_context2.prev = _context2.next) {
          case 0:
            debug = args.debug;
            email = void 0;
            emailIsValid = false;

          case 3:
            _context2.prev = 3;
            _context2.next = 6;
            return Object(__WEBPACK_IMPORTED_MODULE_6__util_prompt_email__["a" /* default */])();

          case 6:
            email = _context2.sent;
            _context2.next = 15;
            break;

          case 9:
            _context2.prev = 9;
            _context2.t0 = _context2['catch'](3);
            erase = '';

            if (_context2.t0.message.includes('Aborted')) {
              // no need to keep the prompt if the user `ctrl+c`ed
              erase = Object(__WEBPACK_IMPORTED_MODULE_5__util_erase_lines__["a" /* default */])(2);
            }
            console.log(erase + _context2.t0.message);
            return _context2.abrupt('return', false);

          case 15:

            emailIsValid = Object(__WEBPACK_IMPORTED_MODULE_7_email_validator__["validate"])(email);
            if (!emailIsValid) {
              // let's erase the `> Enter email [...]`
              // we can't use `console.log()` because it appends a `\n`
              // we need this check because `email-prompt` doesn't print
              // anything if there's no TTY
              process.stdout.write(Object(__WEBPACK_IMPORTED_MODULE_5__util_erase_lines__["a" /* default */])(2));
            }

          case 17:
            if (!emailIsValid) {
              _context2.next = 3;
              break;
            }

          case 18:
            _context2.next = 20;
            return Object(__WEBPACK_IMPORTED_MODULE_3_inquirer__["prompt"])({
              name: 'password',
              type: 'password',
              message: 'Enter your password:',
              validate: function validate(input) {
                if (input.length === 0) {
                  return false;
                }
                return true;
              }
            });

          case 20:
            _ref2 = _context2.sent;
            password = _ref2.password;
            _context2.prev = 22;
            _context2.next = 25;
            return __WEBPACK_IMPORTED_MODULE_2_async_retry___default()(function () {
              var _ref4 = _asyncToGenerator( /*#__PURE__*/__WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator___default.a.mark(function _callee(bail) {
                var _ref5, data;

                return __WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator___default.a.wrap(function _callee$(_context) {
                  while (1) {
                    switch (_context.prev = _context.next) {
                      case 0:
                        _context.prev = 0;
                        _context.next = 3;
                        return __WEBPACK_IMPORTED_MODULE_1_axios___default.a.post('/v1/login', { email: email, password: password }, {
                          baseURL: config.apiURL
                        });

                      case 3:
                        _ref5 = _context.sent;
                        data = _ref5.data;
                        return _context.abrupt('return', data);

                      case 8:
                        _context.prev = 8;
                        _context.t0 = _context['catch'](0);

                        if (!(_context.t0.response.status === 401)) {
                          _context.next = 12;
                          break;
                        }

                        return _context.abrupt('return', bail(_context.t0));

                      case 12:
                        debug && console.log('[debug] retrying...');
                        throw _context.t0;

                      case 14:
                      case 'end':
                        return _context.stop();
                    }
                  }
                }, _callee, _this, [[0, 8]]);
              }));

              return function (_x3) {
                return _ref4.apply(this, arguments);
              };
            }());

          case 25:
            _ref3 = _context2.sent;
            api_token = _ref3.api_token;


            Object(__WEBPACK_IMPORTED_MODULE_4_fs_extra__["writeFileSync"])(config.liaraConfPath, JSON.stringify({
              api_token: api_token
            }));

            console.log('> Auth credentials saved in ' + Object(__WEBPACK_IMPORTED_MODULE_8_chalk__["bold"])(config.liaraConfPath));

            console.log(Object(__WEBPACK_IMPORTED_MODULE_8_chalk__["green"])('You have logged in successfully.'));

            _context2.next = 38;
            break;

          case 32:
            _context2.prev = 32;
            _context2.t1 = _context2['catch'](22);

            if (!(_context2.t1.response && _context2.t1.response.status === 401)) {
              _context2.next = 37;
              break;
            }

            console.error(Object(__WEBPACK_IMPORTED_MODULE_8_chalk__["red"])('> Error!') + ' Authentication failed. Please try again.');
            return _context2.abrupt('return', false);

          case 37:
            throw _context2.t1;

          case 38:
            return _context2.abrupt('return', true);

          case 39:
          case 'end':
            return _context2.stop();
        }
      }
    }, _callee2, this, [[3, 9], [22, 32]]);
  }));

  function login(_x, _x2) {
    return _ref.apply(this, arguments);
  }

  return login;
})());

/***/ }),
/* 10 */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0_crypto__ = __webpack_require__(34);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0_crypto___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_0_crypto__);


var hash = function hash(buf) {
  return __WEBPACK_IMPORTED_MODULE_0_crypto___default.a.createHash('sha256').update(buf).digest('hex');
};

/* harmony default export */ __webpack_exports__["a"] = (hash);

/***/ }),
/* 11 */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
Object.defineProperty(__webpack_exports__, "__esModule", { value: true });
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0_mri__ = __webpack_require__(12);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0_mri___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_0_mri__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1_path__ = __webpack_require__(3);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1_path___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_1_path__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_2_os__ = __webpack_require__(4);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_2_os___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_2_os__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_3_fs_extra__ = __webpack_require__(1);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_3_fs_extra___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_3_fs_extra__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_4_update_notifier__ = __webpack_require__(13);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_4_update_notifier___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_4_update_notifier__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_5__util_error__ = __webpack_require__(5);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_6__package_json__ = __webpack_require__(14);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_6__package_json___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_6__package_json__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_7__commands__ = __webpack_require__(15);
var _slicedToArray = function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"]) _i["return"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } }; }();











__WEBPACK_IMPORTED_MODULE_4_update_notifier___default()({ pkg: __WEBPACK_IMPORTED_MODULE_6__package_json___default.a }).notify();

process.on('uncaughtException', __WEBPACK_IMPORTED_MODULE_5__util_error__["a" /* default */]);
process.on('unhandledRejection', __WEBPACK_IMPORTED_MODULE_5__util_error__["a" /* default */]);

var args = __WEBPACK_IMPORTED_MODULE_0_mri___default()(process.argv.slice(2), {
  alias: {
    project: ['p']
  }
});

// extract first argument as the command name

var _args$_ = _slicedToArray(args._, 1),
    command = _args$_[0];

var apiURL = void 0;
if (args.dev) {
  apiURL = 'http://localhost:3000';
} else {
  apiURL = args.api ? args.api : 'https://api.liara.ir';
}

var liaraConfPath = Object(__WEBPACK_IMPORTED_MODULE_1_path__["join"])(Object(__WEBPACK_IMPORTED_MODULE_2_os__["homedir"])(), '.liara.json');

var liaraConf = void 0;
try {
  if (!args['api-token']) {
    liaraConf = JSON.parse(Object(__WEBPACK_IMPORTED_MODULE_3_fs_extra__["readFileSync"])(liaraConfPath));
  } else {
    liaraConf = {};
    liaraConf.api_token = args['api-token'];
  }
} catch (err) {
  liaraConf = {};
}

var config = Object.assign({}, liaraConf, {
  apiURL: apiURL,
  liaraConfPath: liaraConfPath
});

if (!command) {
  // no arguments passed, so we should run default command
  __WEBPACK_IMPORTED_MODULE_7__commands__["a" /* default */].deploy(args, config);
} else {
  if (!(command in __WEBPACK_IMPORTED_MODULE_7__commands__["a" /* default */])) {
    throw new Error('\'' + command + '\' command is not defined.');
  }

  __WEBPACK_IMPORTED_MODULE_7__commands__["a" /* default */][command](args, config);
}

/***/ }),
/* 12 */
/***/ (function(module, exports) {

module.exports = require("mri");

/***/ }),
/* 13 */
/***/ (function(module, exports) {

module.exports = require("update-notifier");

/***/ }),
/* 14 */
/***/ (function(module, exports) {

module.exports = {"name":"@liara/cli","version":"0.2.11","description":"The command line interface for Liara","bin":{"liara":"dist/liara.js"},"scripts":{"build":"webpack","dev":"webpack --watch","prepublishOnly":"webpack","deploy":"npm publish --access public","test":"NODE_ENV=test mocha --require babel-register tests"},"repository":"https://github.com/liara-ir/liara-cli","author":"Mhe Mrg <mhemrg120@gmail.com> (http://liara.ir/)","license":"MIT","devDependencies":{"babel-core":"^6.26.0","babel-loader":"^7.1.2","babel-preset-backpack":"^0.4.3","chai":"^4.1.2","mocha":"^4.0.1","shebang-loader":"^0.0.1","webpack":"^3.8.1","webpack-node-externals":"^1.6.0"},"dependencies":{"ansi-escapes":"^3.0.0","archiver":"^3.0.0","async-retry":"^1.1.4","axios":"^0.18.0","babel-runtime":"^6.26.0","boxen":"^1.3.0","bytes":"^3.0.0","chalk":"^2.3.0","concat-stream":"^1.6.2","email-prompt":"^0.3.1","email-validator":"^1.1.1","figures":"^2.0.0","fs-extra":"^4.0.2","ignore":"^5.1.0","inquirer":"^6.2.1","klaw":"^2.1.0","mri":"^1.1.0","ora":"^2.1.0","progress":"^2.0.3","request":"^2.88.0","through2":"^2.0.3","update-notifier":"^2.5.0"}}

/***/ }),
/* 15 */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__deploy__ = __webpack_require__(16);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1__login__ = __webpack_require__(9);
// import db from './db';



/* harmony default export */ __webpack_exports__["a"] = ({
  // db,
  deploy: __WEBPACK_IMPORTED_MODULE_0__deploy__["a" /* default */],
  login: __WEBPACK_IMPORTED_MODULE_1__login__["a" /* default */]
});

/***/ }),
/* 16 */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator__ = __webpack_require__(2);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1_ora__ = __webpack_require__(18);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1_ora___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_1_ora__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_2_axios__ = __webpack_require__(6);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_2_axios___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_2_axios__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_3_bytes__ = __webpack_require__(19);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_3_bytes___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_3_bytes__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_4_os__ = __webpack_require__(4);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_4_os___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_4_os__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_5_request__ = __webpack_require__(20);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_5_request___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_5_request__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_6_archiver__ = __webpack_require__(21);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_6_archiver___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_6_archiver__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_7_async_retry__ = __webpack_require__(7);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_7_async_retry___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_7_async_retry__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_8_events__ = __webpack_require__(22);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_8_events___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_8_events__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_9_inquirer__ = __webpack_require__(8);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_9_inquirer___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_9_inquirer__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_10_progress__ = __webpack_require__(23);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_10_progress___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_10_progress__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_11_concat_stream__ = __webpack_require__(24);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_11_concat_stream___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_11_concat_stream__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_12_path__ = __webpack_require__(3);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_12_path___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_12_path__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_13_follow_redirects__ = __webpack_require__(25);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_13_follow_redirects___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_13_follow_redirects__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_14_chalk__ = __webpack_require__(0);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_14_chalk___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_14_chalk__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_15_fs_extra__ = __webpack_require__(1);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_15_fs_extra___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_15_fs_extra__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_16__util_error__ = __webpack_require__(5);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_17__middlewares_auth__ = __webpack_require__(26);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_18__util_get_files__ = __webpack_require__(32);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_19__util_get_port__ = __webpack_require__(37);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_20__util_detect_deployment_type__ = __webpack_require__(38);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_21__util_ensure_has_dockerfile__ = __webpack_require__(39);


var uploadMissingFiles = function () {
  var _ref6 = _asyncToGenerator( /*#__PURE__*/__WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator___default.a.mark(function _callee3(mapHashesToFiles, missing_files, config, spinner) {
    var archive, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, hash, _mapHashesToFiles$get, data, tmpArchivePath, archiveSize, tmpArchiveStream, bar;

    return __WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator___default.a.wrap(function _callee3$(_context3) {
      while (1) {
        switch (_context3.prev = _context3.next) {
          case 0:
            archive = __WEBPACK_IMPORTED_MODULE_6_archiver___default()('tar', {
              gzip: true,
              gzipOptions: { level: 9 }
            });


            archive.on('error', function (err) {
              throw err;
            });

            _iteratorNormalCompletion = true;
            _didIteratorError = false;
            _iteratorError = undefined;
            _context3.prev = 5;
            for (_iterator = missing_files[Symbol.iterator](); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
              hash = _step.value;
              _mapHashesToFiles$get = mapHashesToFiles.get(hash), data = _mapHashesToFiles$get.data;

              archive.append(data, { name: hash });
            }

            _context3.next = 13;
            break;

          case 9:
            _context3.prev = 9;
            _context3.t0 = _context3['catch'](5);
            _didIteratorError = true;
            _iteratorError = _context3.t0;

          case 13:
            _context3.prev = 13;
            _context3.prev = 14;

            if (!_iteratorNormalCompletion && _iterator.return) {
              _iterator.return();
            }

          case 16:
            _context3.prev = 16;

            if (!_didIteratorError) {
              _context3.next = 19;
              break;
            }

            throw _iteratorError;

          case 19:
            return _context3.finish(16);

          case 20:
            return _context3.finish(13);

          case 21:
            archive.finalize();
            spinner.stop();

            tmpArchivePath = Object(__WEBPACK_IMPORTED_MODULE_12_path__["join"])(Object(__WEBPACK_IMPORTED_MODULE_4_os__["tmpdir"])(), Date.now() + '.tar.gz');
            _context3.next = 26;
            return new Promise(function (resolve, reject) {
              archive.pipe(__WEBPACK_IMPORTED_MODULE_15_fs_extra___default.a.createWriteStream(tmpArchivePath)).on('error', reject).on('close', function () {
                var _fs$statSync = __WEBPACK_IMPORTED_MODULE_15_fs_extra___default.a.statSync(tmpArchivePath),
                    size = _fs$statSync.size;

                resolve(size);
              });
            });

          case 26:
            archiveSize = _context3.sent;


            console.log(Object(__WEBPACK_IMPORTED_MODULE_14_chalk__["gray"])('Compressed size:') + ' ' + __WEBPACK_IMPORTED_MODULE_3_bytes___default()(archiveSize));

            tmpArchiveStream = __WEBPACK_IMPORTED_MODULE_15_fs_extra___default.a.createReadStream(tmpArchivePath);
            bar = new __WEBPACK_IMPORTED_MODULE_10_progress___default.a('Uploading [:bar] :rate/bps :percent :etas', { total: archiveSize });
            return _context3.abrupt('return', new Promise(function (resolve) {
              var req = __WEBPACK_IMPORTED_MODULE_5_request___default.a.post({
                url: '/v1/files/archive',
                baseUrl: config.apiURL,
                data: tmpArchiveStream,
                headers: {
                  'Content-Type': 'application/octet-stream',
                  Authorization: 'Bearer ' + config.api_token
                }
              });

              var interval = setInterval(function () {
                bar.tick(req.req.connection._bytesDispatched - bar.curr);

                if (bar.complete) {
                  spinner.succeed('Upload finished.');
                  spinner.start('Extracting...');
                  clearInterval(interval);
                }
              }, 250);

              tmpArchiveStream.pipe(req).on('response', function () {
                spinner.succeed('Extract finished.');
                spinner.start('Deploying...');
                __WEBPACK_IMPORTED_MODULE_15_fs_extra___default.a.unlink(tmpArchivePath);
                resolve();
              });
            }));

          case 31:
          case 'end':
            return _context3.stop();
        }
      }
    }, _callee3, this, [[5, 9, 13, 21], [14,, 16, 20]]);
  }));

  return function uploadMissingFiles(_x4, _x5, _x6, _x7) {
    return _ref6.apply(this, arguments);
  };
}();

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }
























__WEBPACK_IMPORTED_MODULE_13_follow_redirects___default.a.maxBodyLength = 200 * 1024 * 1024; // 200 MB

/* harmony default export */ __webpack_exports__["a"] = (Object(__WEBPACK_IMPORTED_MODULE_17__middlewares_auth__["a" /* default */])(function () {
  var _ref = _asyncToGenerator( /*#__PURE__*/__WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator___default.a.mark(function _callee2(args, config) {
    var _this = this;

    var spinner, project, path, debug, dev, port, platform, mountPoint, projectId, projectPath, liaraJSONPath, APIConfig, clearAndLog, logInfo, hasLiaraJSONFile, liaraJSON, promptResult, _ref2, projects, packageJSON, _promptResult, _ref3, files, directories, mapHashesToFiles, totalBytes, _ensureAppHasDockerfi, filesWithDockerfile, mapHashesToFilesWithDockerfile;

    return __WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator___default.a.wrap(function _callee2$(_context2) {
      while (1) {
        switch (_context2.prev = _context2.next) {
          case 0:
            spinner = __WEBPACK_IMPORTED_MODULE_1_ora___default()('Loading projects...').start();
            project = args.project, path = args.path, debug = args.debug, dev = args.dev;
            port = args.port;
            platform = void 0;
            mountPoint = void 0;
            projectId = typeof project === 'boolean' ? null : project;
            projectPath = path ? path : process.cwd();
            liaraJSONPath = Object(__WEBPACK_IMPORTED_MODULE_12_path__["join"])(projectPath, 'liara.json');
            APIConfig = {
              baseURL: config.apiURL,
              headers: {
                Authorization: 'Bearer ' + config.api_token
              }
            };

            clearAndLog = function clearAndLog() {
              var _console;

              spinner.clear();
              spinner.frame();
              (_console = console).log.apply(_console, arguments);
            };

            logInfo = function logInfo(title, value) {
              clearAndLog(Object(__WEBPACK_IMPORTED_MODULE_14_chalk__["gray"])(title + ':') + ' ' + value);
            };

            hasLiaraJSONFile = Object(__WEBPACK_IMPORTED_MODULE_15_fs_extra__["existsSync"])(liaraJSONPath);

            if (!hasLiaraJSONFile) {
              _context2.next = 33;
              break;
            }

            liaraJSON = void 0;
            _context2.prev = 14;

            liaraJSON = Object(__WEBPACK_IMPORTED_MODULE_15_fs_extra__["readJSONSync"])(liaraJSONPath) || {};
            _context2.next = 21;
            break;

          case 18:
            _context2.prev = 18;
            _context2.t0 = _context2['catch'](14);
            throw new Error('Syntax error in `liara.json`!');

          case 21:

            if (!project) {
              projectId = liaraJSON.project;
            }

            if (!(!port && liaraJSON.port)) {
              _context2.next = 26;
              break;
            }

            port = Number(liaraJSON.port);

            if (!isNaN(port)) {
              _context2.next = 26;
              break;
            }

            throw new TypeError('The `port` field in `liara.json` must be a number.');

          case 26:

            platform = liaraJSON.platform;

            if (!(platform && typeof platform !== 'string')) {
              _context2.next = 29;
              break;
            }

            throw new TypeError('The `platform` field in `liara.json` must be a string.');

          case 29:
            if (!liaraJSON.volume) {
              _context2.next = 33;
              break;
            }

            mountPoint = liaraJSON.volume;

            if (Object(__WEBPACK_IMPORTED_MODULE_12_path__["isAbsolute"])(mountPoint)) {
              _context2.next = 33;
              break;
            }

            throw new Error('The `volume` field in `liara.json` must be an absolute path.');

          case 33:
            if (projectId) {
              _context2.next = 49;
              break;
            }

            promptResult = void 0;
            _context2.next = 37;
            return __WEBPACK_IMPORTED_MODULE_2_axios___default.a.get('/v1/projects', APIConfig);

          case 37:
            _ref2 = _context2.sent;
            projects = _ref2.data.projects;


            spinner.stop();

            if (projects.length) {
              _context2.next = 45;
              break;
            }

            console.info('Please go to https://console.liara.ir/projects and create a project, first.');
            process.exit(1);

            _context2.next = 48;
            break;

          case 45:
            _context2.next = 47;
            return Object(__WEBPACK_IMPORTED_MODULE_9_inquirer__["prompt"])({
              name: 'projectId',
              type: 'list',
              message: 'Please select a project:',
              choices: [].concat(_toConsumableArray(projects.map(function (project) {
                return project.project_id;
              })))
            });

          case 47:
            promptResult = _context2.sent;

          case 48:

            projectId = promptResult.projectId;

          case 49:

            logInfo('Project', projectId);
            logInfo('Deploying', projectPath);

            if (platform) {
              logInfo('Platform', platform);
            } else {
              try {
                platform = Object(__WEBPACK_IMPORTED_MODULE_20__util_detect_deployment_type__["a" /* default */])(args, projectPath);
                logInfo('Detected platform', platform);
              } catch (error) {
                console.log(Object(__WEBPACK_IMPORTED_MODULE_14_chalk__["red"])('> Error!'), error.message);
                process.exit(1);
              }
            }

            if (platform === 'node') {
              packageJSON = Object(__WEBPACK_IMPORTED_MODULE_15_fs_extra__["readJSONSync"])(Object(__WEBPACK_IMPORTED_MODULE_12_path__["join"])(projectPath, 'package.json'));


              if (!packageJSON.scripts || !packageJSON.scripts.start) {
                Object(__WEBPACK_IMPORTED_MODULE_16__util_error__["a" /* default */])('A NodeJS project must be runnable with `npm start`.');
                console.info('You must add a `start` command to your package.json scripts.');
                process.exit(1);
              }
            }

            if (platform === 'wordpress') {
              mountPoint = '/var/www/html';
            }

            if (!port) {
              _context2.next = 58;
              break;
            }

            logInfo('Port', port);

            _context2.next = 67;
            break;

          case 58:
            port = Object(__WEBPACK_IMPORTED_MODULE_19__util_get_port__["a" /* default */])(platform);

            if (!port) {
              _context2.next = 63;
              break;
            }

            logInfo('Default port', port);

            _context2.next = 67;
            break;

          case 63:
            _context2.next = 65;
            return Object(__WEBPACK_IMPORTED_MODULE_9_inquirer__["prompt"])({
              name: 'port',
              type: 'input',
              default: 3000,
              message: 'Enter the port your app listens to:',
              validate: function validate(input) {
                input = Number(input);
                if (!input) {
                  return 'Port must be a number.';
                }
                if (!Number.isInteger(input)) {
                  return 'Port must be an integer.';
                }
                return true;
              }
            });

          case 65:
            _promptResult = _context2.sent;


            port = _promptResult.port;

          case 67:

            spinner.start('Compressing...');

            debug && console.time('[debug] making hashes');
            _context2.next = 71;
            return Object(__WEBPACK_IMPORTED_MODULE_18__util_get_files__["a" /* default */])(projectPath);

          case 71:
            _ref3 = _context2.sent;
            files = _ref3.files;
            directories = _ref3.directories;
            mapHashesToFiles = _ref3.mapHashesToFiles;

            debug && console.log('[debug] files count:', files.length);
            debug && console.timeEnd('[debug] making hashes');

            totalBytes = files.reduce(function (sum, file) {
              return sum + file.size;
            }, 0);

            logInfo('Project size', __WEBPACK_IMPORTED_MODULE_3_bytes___default()(totalBytes));

            debug && console.time('[debug] Ensure app has Dockerfile');
            _ensureAppHasDockerfi = Object(__WEBPACK_IMPORTED_MODULE_21__util_ensure_has_dockerfile__["a" /* default */])(platform, files, mapHashesToFiles), filesWithDockerfile = _ensureAppHasDockerfi.filesWithDockerfile, mapHashesToFilesWithDockerfile = _ensureAppHasDockerfi.mapHashesToFilesWithDockerfile;

            debug && console.timeEnd('[debug] Ensure app has Dockerfile');

            _context2.prev = 82;
            _context2.next = 85;
            return __WEBPACK_IMPORTED_MODULE_7_async_retry___default()(function () {
              var _ref4 = _asyncToGenerator( /*#__PURE__*/__WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator___default.a.mark(function _callee(bail) {
                var body, url, _ref5, stream, buildEvents, tmp, response, data, missing_files;

                return __WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator___default.a.wrap(function _callee$(_context) {
                  while (1) {
                    switch (_context.prev = _context.next) {
                      case 0:
                        body = {
                          port: port,
                          mountPoint: mountPoint,
                          directories: directories,
                          type: platform,
                          project: projectId,
                          files: filesWithDockerfile
                        };
                        url = '/v1/projects/' + projectId + '/releases';
                        _context.prev = 2;

                        debug && console.time('stream');
                        debug && console.log('[debug] Calling', url, '...');

                        _context.next = 7;
                        return __WEBPACK_IMPORTED_MODULE_2_axios___default.a.post(url, body, Object.assign({}, APIConfig, {
                          responseType: 'stream'
                        }));

                      case 7:
                        _ref5 = _context.sent;
                        stream = _ref5.data;


                        spinner.start('Building...');

                        buildEvents = new __WEBPACK_IMPORTED_MODULE_8_events___default.a();
                        tmp = '';

                        stream.on('data', function (data) {
                          tmp += tmp ? data : data.toString().slice(6);

                          try {
                            var obj = JSON.parse(tmp);
                            buildEvents.emit('data', obj);
                            tmp = '';
                          } catch (_) {
                            // JSON.parse may fail if JSON is not complete yet
                          }
                        });

                        buildEvents.on('data', function (line) {
                          if (line.state === 'BUILD_FINISHED') {
                            spinner.succeed('Build finished.');
                            spinner.start('Pushing the image...');
                            return;
                          }

                          if (line.state === 'CREATING_SERVICE') {
                            spinner.succeed('Image pushed.');
                            spinner.start('Starting the service...');
                            return;
                          }

                          if (line.state === 'FAILED') {
                            spinner.stop();

                            console.log();
                            console.log(Object(__WEBPACK_IMPORTED_MODULE_14_chalk__["red"])('Deployment failed :('));
                            console.log('Please try again later or contact us.');
                            console.log();

                            return;
                          }

                          if (line.state === 'READY') {
                            spinner.stop();

                            console.log();
                            console.log(Object(__WEBPACK_IMPORTED_MODULE_14_chalk__["green"])('Deployment finished successfully.'));
                            console.log(Object(__WEBPACK_IMPORTED_MODULE_14_chalk__["white"])('Open up the url below in your browser:'));
                            console.log();
                            dev ? console.log('    ' + Object(__WEBPACK_IMPORTED_MODULE_14_chalk__["cyan"])('http://' + projectId + '.liara.localhost')) : console.log('    ' + Object(__WEBPACK_IMPORTED_MODULE_14_chalk__["cyan"])('https://' + projectId + '.liara.run'));
                            console.log();

                            return;
                          }

                          if (line.message) {
                            clearAndLog(Object(__WEBPACK_IMPORTED_MODULE_14_chalk__["cyan"])('>'), line.message.trim());
                            return;
                          }

                          console.log(line);
                        }).on('end', function () {
                          debug && console.log('Stream finished.');
                          debug && console.timeEnd('stream');
                        });

                        _context.next = 35;
                        break;

                      case 16:
                        _context.prev = 16;
                        _context.t0 = _context['catch'](2);

                        debug && console.log('[debug]', _context.t0.message);

                        response = _context.t0.response;

                        // Unknown error

                        if (response) {
                          _context.next = 22;
                          break;
                        }

                        return _context.abrupt('return', bail(_context.t0));

                      case 22:
                        _context.next = 24;
                        return new Promise(function (resolve) {
                          _context.t0.response.data.pipe(__WEBPACK_IMPORTED_MODULE_11_concat_stream___default()({ encoding: 'string' }, function (data) {
                            resolve(JSON.parse(data));
                          }));
                        });

                      case 24:
                        data = _context.sent;


                        if (response.status === 402) {
                          spinner.fail('You don\'t have enough balance. Payment required.');
                          process.exit(1);
                        }

                        if (response.status === 400 && data.message === 'frozen_project') {
                          spinner.fail('Project is frozen (not enough balance).\nPlease open up https://console.liara.ir/projects and unfreeze the project.');
                          process.exit(1);
                        }

                        if (!(response.status === 400 && data.message === 'missing_files')) {
                          _context.next = 33;
                          break;
                        }

                        missing_files = data.missing_files;


                        debug && console.log('[debug] missing files: ' + missing_files.length);

                        _context.next = 32;
                        return uploadMissingFiles(mapHashesToFilesWithDockerfile, missing_files, config, spinner);

                      case 32:
                        throw _context.t0;

                      case 33:
                        if (!(response.status >= 400 && response.status < 500)) {
                          _context.next = 35;
                          break;
                        }

                        return _context.abrupt('return', bail(_context.t0));

                      case 35:
                      case 'end':
                        return _context.stop();
                    }
                  }
                }, _callee, _this, [[2, 16]]);
              }));

              return function (_x3) {
                return _ref4.apply(this, arguments);
              };
            }(), {
              onRetry: function onRetry(error) {
                debug && console.log('[debug] Retrying deployment, error:');
                debug && console.log('[debug]', error.message);
              }
            });

          case 85:
            _context2.next = 92;
            break;

          case 87:
            _context2.prev = 87;
            _context2.t1 = _context2['catch'](82);

            debug && console.error(_context2.t1);
            spinner.fail(_context2.t1.message);
            console.info('Sorry for inconvenience. Please contact us.');

          case 92:
          case 'end':
            return _context2.stop();
        }
      }
    }, _callee2, this, [[14, 18], [82, 87]]);
  }));

  function deploy(_x, _x2) {
    return _ref.apply(this, arguments);
  }

  return deploy;
}()));

/***/ }),
/* 17 */
/***/ (function(module, exports) {

module.exports = require("regenerator-runtime");

/***/ }),
/* 18 */
/***/ (function(module, exports) {

module.exports = require("ora");

/***/ }),
/* 19 */
/***/ (function(module, exports) {

module.exports = require("bytes");

/***/ }),
/* 20 */
/***/ (function(module, exports) {

module.exports = require("request");

/***/ }),
/* 21 */
/***/ (function(module, exports) {

module.exports = require("archiver");

/***/ }),
/* 22 */
/***/ (function(module, exports) {

module.exports = require("events");

/***/ }),
/* 23 */
/***/ (function(module, exports) {

module.exports = require("progress");

/***/ }),
/* 24 */
/***/ (function(module, exports) {

module.exports = require("concat-stream");

/***/ }),
/* 25 */
/***/ (function(module, exports) {

module.exports = require("follow-redirects");

/***/ }),
/* 26 */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
/* harmony export (immutable) */ __webpack_exports__["a"] = auth;
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator__ = __webpack_require__(2);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1__commands_login__ = __webpack_require__(9);


function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }



function auth(fn) {
  return function () {
    var _ref = _asyncToGenerator( /*#__PURE__*/__WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator___default.a.mark(function _callee(args, config) {
      return __WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator___default.a.wrap(function _callee$(_context) {
        while (1) {
          switch (_context.prev = _context.next) {
            case 0:
              if (config.api_token) {
                _context.next = 6;
                break;
              }

              console.log('> No existing credentials found. Please log in:');
              _context.next = 4;
              return Object(__WEBPACK_IMPORTED_MODULE_1__commands_login__["a" /* default */])(args, config);

            case 4:
              if (_context.sent) {
                _context.next = 6;
                break;
              }

              return _context.abrupt('return');

            case 6:
              _context.next = 8;
              return fn(args, config);

            case 8:
              return _context.abrupt('return', _context.sent);

            case 9:
            case 'end':
              return _context.stop();
          }
        }
      }, _callee, this);
    }));

    return function (_x, _x2) {
      return _ref.apply(this, arguments);
    };
  }();
}

/***/ }),
/* 27 */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0_ansi_escapes__ = __webpack_require__(28);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0_ansi_escapes___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_0_ansi_escapes__);


var eraseLines = function eraseLines(n) {
  return __WEBPACK_IMPORTED_MODULE_0_ansi_escapes___default.a.eraseLines(n);
};

/* harmony default export */ __webpack_exports__["a"] = (eraseLines);

/***/ }),
/* 28 */
/***/ (function(module, exports) {

module.exports = require("ansi-escapes");

/***/ }),
/* 29 */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator__ = __webpack_require__(2);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1_chalk__ = __webpack_require__(0);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1_chalk___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_1_chalk__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_2_email_prompt__ = __webpack_require__(30);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_2_email_prompt___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_2_email_prompt__);


var _this = this;

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }





/* harmony default export */ __webpack_exports__["a"] = (_asyncToGenerator( /*#__PURE__*/__WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator___default.a.mark(function _callee() {
  var email;
  return __WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator___default.a.wrap(function _callee$(_context) {
    while (1) {
      switch (_context.prev = _context.next) {
        case 0:
          email = void 0;
          _context.prev = 1;
          _context.next = 4;
          return __WEBPACK_IMPORTED_MODULE_2_email_prompt___default()({ start: Object(__WEBPACK_IMPORTED_MODULE_1_chalk__["green"])('?') + ' Enter your email: ' });

        case 4:
          email = _context.sent;
          _context.next = 14;
          break;

        case 7:
          _context.prev = 7;
          _context.t0 = _context['catch'](1);

          console.log(); // \n

          if (!(_context.t0.message === 'User abort')) {
            _context.next = 12;
            break;
          }

          throw new Error(Object(__WEBPACK_IMPORTED_MODULE_1_chalk__["red"])('> Aborted!') + ' No changes made.');

        case 12:
          if (!(_context.t0.message === 'stdin lacks setRawMode support')) {
            _context.next = 14;
            break;
          }

          throw new Error(error('Interactive mode not supported \u2013 please run ' + Object(__WEBPACK_IMPORTED_MODULE_1_chalk__["green"])('liara login --email you@domain.com --password your_password')));

        case 14:

          console.log(); // \n
          return _context.abrupt('return', email);

        case 16:
        case 'end':
          return _context.stop();
      }
    }
  }, _callee, _this, [[1, 7]]);
})));

/***/ }),
/* 30 */
/***/ (function(module, exports) {

module.exports = require("email-prompt");

/***/ }),
/* 31 */
/***/ (function(module, exports) {

module.exports = require("email-validator");

/***/ }),
/* 32 */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator__ = __webpack_require__(2);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1_klaw__ = __webpack_require__(33);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1_klaw___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_1_klaw__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_2__hash__ = __webpack_require__(10);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_3_through2__ = __webpack_require__(35);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_3_through2___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_3_through2__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_4_path__ = __webpack_require__(3);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_4_path___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_4_path__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_5_fs_extra__ = __webpack_require__(1);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_5_fs_extra___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_5_fs_extra__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_6_ignore__ = __webpack_require__(36);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_6_ignore___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_6_ignore__);


var _slicedToArray = function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"]) _i["return"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } }; }();

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }








var defaultIgnores = ['.git', '.idea', '.vscode', '.gitignore', '.liaraignore', '*.*~', 'node_modules', 'bower_components'];

var addNestedGitignores = function addNestedGitignores(ignoreInstance, projectPath) {
  ignoreInstance.add(defaultIgnores);

  return __WEBPACK_IMPORTED_MODULE_3_through2___default.a.obj(function (item, enc, next) {
    if (Object(__WEBPACK_IMPORTED_MODULE_4_path__["basename"])(item.path) === '.gitignore') {
      var removeEmptyLines = function removeEmptyLines(lines) {
        return lines.filter(function (line) {
          return line.trim().length > 0;
        });
      };
      var patterns = removeEmptyLines(Object(__WEBPACK_IMPORTED_MODULE_5_fs_extra__["readFileSync"])(item.path).toString().split('\n'));

      var relativeToProjectPath = patterns.map(function (pattern) {
        var prefix = pattern.startsWith('/') ? '/' : '';
        return prefix + Object(__WEBPACK_IMPORTED_MODULE_4_path__["relative"])(projectPath, Object(__WEBPACK_IMPORTED_MODULE_4_path__["join"])(Object(__WEBPACK_IMPORTED_MODULE_4_path__["dirname"])(item.path), pattern));
      });

      ignoreInstance.add(relativeToProjectPath);
    }

    this.push(item);
    return next();
  });
};

var ignoreFiles = function ignoreFiles(ignoreInstance, projectPath) {
  var liaragnorePath = Object(__WEBPACK_IMPORTED_MODULE_4_path__["join"])(projectPath, '.liaraignore');
  var gitignorePath = Object(__WEBPACK_IMPORTED_MODULE_4_path__["join"])(projectPath, '.gitignore');

  if (Object(__WEBPACK_IMPORTED_MODULE_5_fs_extra__["existsSync"])(liaragnorePath)) {
    ignoreInstance = __WEBPACK_IMPORTED_MODULE_6_ignore___default()({ ignorecase: false });
    ignoreInstance.add(defaultIgnores);
    ignoreInstance.add(Object(__WEBPACK_IMPORTED_MODULE_5_fs_extra__["readFileSync"])(liaragnorePath).toString());
  }

  return __WEBPACK_IMPORTED_MODULE_3_through2___default.a.obj(function (item, enc, next) {
    var itemPath = Object(__WEBPACK_IMPORTED_MODULE_4_path__["relative"])(projectPath, item.path);
    if (itemPath && !ignoreInstance.ignores(Object(__WEBPACK_IMPORTED_MODULE_4_path__["relative"])(projectPath, item.path))) {
      this.push(item);
    }
    return next();
  });
};

/* harmony default export */ __webpack_exports__["a"] = ((function () {
  var _ref = _asyncToGenerator( /*#__PURE__*/__WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator___default.a.mark(function _callee3(projectPath) {
    var _this = this;

    var mapHashesToFiles, directories, ignoreInstance, files;
    return __WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator___default.a.wrap(function _callee3$(_context3) {
      while (1) {
        switch (_context3.prev = _context3.next) {
          case 0:
            mapHashesToFiles = new Map();
            directories = [];
            ignoreInstance = __WEBPACK_IMPORTED_MODULE_6_ignore___default()({ ignorecase: false });
            _context3.next = 5;
            return new Promise(function (resolve) {
              var files = [];

              __WEBPACK_IMPORTED_MODULE_1_klaw___default()(projectPath).pipe(addNestedGitignores(ignoreInstance, projectPath)).pipe(ignoreFiles(ignoreInstance, projectPath)).on('data', function (file) {
                return files.push(file);
              }).on('end', _asyncToGenerator( /*#__PURE__*/__WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator___default.a.mark(function _callee2() {
                return __WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator___default.a.wrap(function _callee2$(_context2) {
                  while (1) {
                    switch (_context2.prev = _context2.next) {
                      case 0:
                        _context2.next = 2;
                        return Promise.all(files.map(function () {
                          var _ref4 = _asyncToGenerator( /*#__PURE__*/__WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator___default.a.mark(function _callee(_ref3) {
                            var path = _ref3.path,
                                stats = _ref3.stats;

                            var mode755, mode644, dir, data, checksum, file, _mapHashesToFiles$get, _files;

                            return __WEBPACK_IMPORTED_MODULE_0__home_mhe_projects_liara_cli_node_modules_babel_runtime_regenerator___default.a.wrap(function _callee$(_context) {
                              while (1) {
                                switch (_context.prev = _context.next) {
                                  case 0:
                                    mode755 = 16893;
                                    mode644 = 33204;

                                    if (stats.isFile()) {
                                      _context.next = 5;
                                      break;
                                    }

                                    dir = {
                                      name: Object(__WEBPACK_IMPORTED_MODULE_4_path__["relative"])(projectPath, path),
                                      mode: mode755,
                                      type: 'directory'
                                    };
                                    return _context.abrupt('return', directories.push(dir));

                                  case 5:
                                    _context.next = 7;
                                    return Object(__WEBPACK_IMPORTED_MODULE_5_fs_extra__["readFile"])(path);

                                  case 7:
                                    data = _context.sent;
                                    checksum = Object(__WEBPACK_IMPORTED_MODULE_2__hash__["a" /* default */])(data);
                                    file = {
                                      checksum: checksum,
                                      path: Object(__WEBPACK_IMPORTED_MODULE_4_path__["relative"])(projectPath, path),
                                      size: stats.size
                                    };
                                    _context.prev = 10;
                                    _context.next = 13;
                                    return __WEBPACK_IMPORTED_MODULE_5_fs_extra___default.a.access(path, __WEBPACK_IMPORTED_MODULE_5_fs_extra___default.a.constants.X_OK);

                                  case 13:

                                    file.mode = mode755;

                                    _context.next = 19;
                                    break;

                                  case 16:
                                    _context.prev = 16;
                                    _context.t0 = _context['catch'](10);

                                    // File is not executable.
                                    file.mode = mode644;

                                  case 19:

                                    if (mapHashesToFiles.has(checksum)) {
                                      _mapHashesToFiles$get = mapHashesToFiles.get(checksum), _files = _mapHashesToFiles$get.files;

                                      mapHashesToFiles.set(checksum, {
                                        data: data,
                                        files: [].concat(_toConsumableArray(_files), [file])
                                      });
                                    } else {
                                      mapHashesToFiles.set(checksum, {
                                        data: data,
                                        files: [file]
                                      });
                                    }

                                  case 20:
                                  case 'end':
                                    return _context.stop();
                                }
                              }
                            }, _callee, _this, [[10, 16]]);
                          }));

                          return function (_x2) {
                            return _ref4.apply(this, arguments);
                          };
                        }()));

                      case 2:
                        resolve();

                      case 3:
                      case 'end':
                        return _context2.stop();
                    }
                  }
                }, _callee2, _this);
              })));
            });

          case 5:

            // flatten files
            files = Array.from(mapHashesToFiles).reduce(function (prevFiles, _ref5) {
              var _ref6 = _slicedToArray(_ref5, 2),
                  checksum = _ref6[0],
                  files = _ref6[1].files;

              return [].concat(_toConsumableArray(prevFiles), _toConsumableArray(files));
            }, []);
            return _context3.abrupt('return', { files: files, directories: directories, mapHashesToFiles: mapHashesToFiles });

          case 7:
          case 'end':
            return _context3.stop();
        }
      }
    }, _callee3, this);
  }));

  function getFiles(_x) {
    return _ref.apply(this, arguments);
  }

  return getFiles;
})());

/***/ }),
/* 33 */
/***/ (function(module, exports) {

module.exports = require("klaw");

/***/ }),
/* 34 */
/***/ (function(module, exports) {

module.exports = require("crypto");

/***/ }),
/* 35 */
/***/ (function(module, exports) {

module.exports = require("through2");

/***/ }),
/* 36 */
/***/ (function(module, exports) {

module.exports = require("ignore");

/***/ }),
/* 37 */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
/* harmony export (immutable) */ __webpack_exports__["a"] = getPort;

function getPort(deploymentType) {
    return {
        node: null,
        static: 80,
        docker: null,
        laravel: 80,
        angular: 80,
        wordpress: 80
    }[deploymentType];
}

/***/ }),
/* 38 */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
/* harmony export (immutable) */ __webpack_exports__["a"] = detectDeploymentType;
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0_path__ = __webpack_require__(3);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0_path___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_0_path__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1_chalk__ = __webpack_require__(0);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1_chalk___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_1_chalk__);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_2_fs_extra__ = __webpack_require__(1);
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_2_fs_extra___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_2_fs_extra__);




function detectDeploymentType(args, projectPath) {
  var packageJsonFilePath = __WEBPACK_IMPORTED_MODULE_0_path___default.a.join(projectPath, 'package.json');
  var composeJsonFilePath = __WEBPACK_IMPORTED_MODULE_0_path___default.a.join(projectPath, 'composer.json');

  var hasPackageFile = Object(__WEBPACK_IMPORTED_MODULE_2_fs_extra__["existsSync"])(packageJsonFilePath);
  var hasComposerJsonFile = Object(__WEBPACK_IMPORTED_MODULE_2_fs_extra__["existsSync"])(composeJsonFilePath);
  var hasDockerFile = Object(__WEBPACK_IMPORTED_MODULE_2_fs_extra__["existsSync"])(__WEBPACK_IMPORTED_MODULE_0_path___default.a.join(projectPath, 'Dockerfile'));
  var hasWPContent = Object(__WEBPACK_IMPORTED_MODULE_2_fs_extra__["existsSync"])(__WEBPACK_IMPORTED_MODULE_0_path___default.a.join(projectPath, 'wp-content'));

  var deploymentTypes = ['node', 'docker', 'static', 'angular', 'laravel', 'wordpress'];

  var specifiedDeploymentTypes = Object.keys(args).filter(function (key) {
    return deploymentTypes.find(function (type) {
      return type === key;
    });
  });

  if (specifiedDeploymentTypes.length > 1) {
    throw new Error('You can not specify multiple deployment types.');
  }

  if (Object(__WEBPACK_IMPORTED_MODULE_2_fs_extra__["readdirSync"])(projectPath).length === 0) {
    throw new Error('Project is empty!');
  }

  if (args.laravel) {
    if (!hasComposerJsonFile) {
      throw new Error(Object(__WEBPACK_IMPORTED_MODULE_1_chalk__["bold"])('`composer.json`') + ' file doesn\'t exists.');
    }
    return 'laravel';
  }

  if (args.node) {
    if (!hasPackageFile) {
      throw new Error(Object(__WEBPACK_IMPORTED_MODULE_1_chalk__["bold"])('`package.json`') + ' file doesn\'t exists.');
    }
    return 'node';
  }

  if (args.angular) {
    if (!hasPackageFile) {
      throw new Error(Object(__WEBPACK_IMPORTED_MODULE_1_chalk__["bold"])('`package.json`') + ' file doesn\'t exists.');
    }
    return 'angular';
  }

  if (args.wordpress) {
    if (!hasWPContent) {
      throw new Error(Object(__WEBPACK_IMPORTED_MODULE_1_chalk__["bold"])('`wp-content`') + ' file doesn\'t exists.');
    }
    return 'wordpress';
  }

  if (args.docker) {
    if (!hasDockerFile) {
      throw new Error(Object(__WEBPACK_IMPORTED_MODULE_1_chalk__["bold"])('`Dockerfile`') + ' file doesn\'t exists.');
    }
    return 'docker';
  }

  if (args.static) {
    return 'static';
  }

  if (hasComposerJsonFile && hasDockerFile) {
    throw new Error('The project contains both of the `composer.json` and `Dockerfile` files.\nPlease specify your deployment type with --laravel or --docker.');
  }

  if (hasComposerJsonFile) {
    var composerJson = Object(__WEBPACK_IMPORTED_MODULE_2_fs_extra__["readJSONSync"])(composeJsonFilePath);

    if (!composerJson.require || !composerJson.require['laravel/framework']) {
      throw new Error('The project contains a `composer.json` file but Laravel framework doesn\'t listed as a dependency.\nCurrently, we only support Laravel projects in the PHP ecosystem.\n');
    }

    return 'laravel';
  }

  if (hasPackageFile && hasDockerFile) {
    throw new Error('The project contains both of the `package.json` and `Dockerfile` files.\nPlease specify your deployment type with --node or --docker.');
  }

  if (hasPackageFile) {
    var packageJson = Object(__WEBPACK_IMPORTED_MODULE_2_fs_extra__["readJSONSync"])(packageJsonFilePath);

    if (packageJson.dependencies && packageJson.dependencies['@angular/core']) {
      return 'angular';
    }

    return 'node';
  }

  if (hasWPContent && hasDockerFile) {
    throw new Error('The project contains a `Dockerfile`.\nPlease specify your deployment type with --wordpress or --docker.');
  }

  if (hasWPContent) {
    return 'wordpress';
  }

  if (hasDockerFile) {
    return 'docker';
  }

  return 'static';
}

/***/ }),
/* 39 */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
/* harmony export (immutable) */ __webpack_exports__["a"] = ensureAppHasDockerfile;
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__hash__ = __webpack_require__(10);
function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }



var dockerfiles = {
  node: Buffer.from('FROM liararepo/node-platform'),
  static: Buffer.from('FROM liararepo/static-platform'),
  laravel: Buffer.from('FROM liararepo/laravel-platform'),
  angular: Buffer.from('FROM liararepo/angular-platform:builder as builder\nFROM liararepo/angular-platform:nginx'),
  wordpress: Buffer.from('FROM liararepo/wordpress-platform')
};

function ensureAppHasDockerfile(deploymentType, files, mapHashesToFiles) {
  if (deploymentType === 'docker') {
    return {
      filesWithDockerfile: files,
      mapHashesToFilesWithDockerfile: mapHashesToFiles
    };
  }

  // get a dockerfile related to the deployment type
  var dockerfile = getDeploymentDockerfile(deploymentType);

  return {
    filesWithDockerfile: [].concat(_toConsumableArray(files.filter(function (file) {
      return file.path !== 'Dockerfile';
    })), [dockerfile]),
    mapHashesToFilesWithDockerfile: new Map(mapHashesToFiles).set(dockerfile.checksum, {
      files: [].concat(_toConsumableArray((mapHashesToFiles.get(dockerfile.checksum) || { files: [] }).files), ['Dockerfile']),
      data: dockerfiles[deploymentType]
    })
  };
}

function getDeploymentDockerfile(deploymentType, files) {
  var dockerfile = {
    path: 'Dockerfile',
    mode: 33204, // _rw_rw_r__
    size: dockerfiles[deploymentType].length,
    checksum: Object(__WEBPACK_IMPORTED_MODULE_0__hash__["a" /* default */])(dockerfiles[deploymentType])
  };

  return dockerfile;
}

/***/ })
/******/ ]);